<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Formulário com Assinatura</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #sigBox {
      border: 1px solid #000;
      height: 200px;
    }
    #sigBox canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #fff;
    }
  </style>
</head>
<body class="p-4">

<div class="container">
  <h2 class="mb-3">Formulário</h2>
  <form id="meuForm" method="post" action="#">
    <div class="mb-3">
      <label class="form-label">Nome</label>
      <input type="text" name="nome" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Mensagem</label>
      <textarea name="mensagem" class="form-control"></textarea>
    </div>

    <div class="mb-3">
      <label class="form-label">Assinatura</label>
      <div id="sigBox">
        <canvas id="sigCanvas"></canvas>
      </div>
      <input type="hidden" name="assinatura" id="assinaturaInput">
      <button type="button" id="clearBtn" class="btn btn-sm btn-secondary mt-2">Limpar</button>
    </div>

    <button type="submit" class="btn btn-primary">Enviar</button>
  </form>
</div>

<script>
  const canvas = document.getElementById("sigCanvas");
  const box = document.getElementById("sigBox");
  const ctx = canvas.getContext("2d");
  const hiddenInput = document.getElementById("assinaturaInput");
  let strokes = [];
  let currentStroke = null;
  let desenhando = false;

  function resizeCanvas() {
    const rect = box.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    desenharTudo();
  }

  function getPos(evt) {
    const rect = canvas.getBoundingClientRect();
    const e = evt.touches ? evt.touches[0] : evt;
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }

  function startDraw(e) {
    e.preventDefault();
    desenhando = true;
    currentStroke = [];
    const p = getPos(e);
    currentStroke.push(p);
  }

  function moveDraw(e) {
    if (!desenhando) return;
    e.preventDefault();
    const p = getPos(e);
    const last = currentStroke[currentStroke.length - 1];
    currentStroke.push(p);
    ctx.beginPath();
    ctx.moveTo(last.x, last.y);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
  }

  function endDraw() {
    if (!desenhando) return;
    desenhando = false;
    if (currentStroke && currentStroke.length > 1) {
      strokes.push(currentStroke);
    }
    currentStroke = null;
  }

  function desenharTudo() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.lineWidth = 2;
    ctx.strokeStyle = "#000";
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    for (const s of strokes) {
      for (let i = 1; i < s.length; i++) {
        ctx.beginPath();
        ctx.moveTo(s[i-1].x, s[i-1].y);
        ctx.lineTo(s[i].x, s[i].y);
        ctx.stroke();
      }
    }
  }

  function limpar() {
    strokes = [];
    desenharTudo();
  }

  // Eventos
  canvas.addEventListener("mousedown", startDraw);
  canvas.addEventListener("mousemove", moveDraw);
  canvas.addEventListener("mouseup", endDraw);

  canvas.addEventListener("touchstart", startDraw);
  canvas.addEventListener("touchmove", moveDraw);
  canvas.addEventListener("touchend", endDraw);

  document.getElementById("clearBtn").addEventListener("click", limpar);

  // Resize inicial
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  // Antes de enviar o form
  document.getElementById("meuForm").addEventListener("submit", (e) => {
    if (strokes.length === 0) {
      e.preventDefault();
      alert("Assine antes de enviar!");
      return;
    }
    hiddenInput.value = canvas.toDataURL();
    alert("Form enviado (assinatura salva no campo hidden).");
  });
</script>

</body>
</html>
